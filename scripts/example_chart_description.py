"""
Ví dụ sử dụng hệ thống mô tả biểu đồ PDF
Simple examples - Sử dụng trong ứng dụng của bạn
"""

# ============================================================================
# EXAMPLE 1: Mô tả biểu đồ từ trang cụ thể
# ============================================================================

from rag.llm import generate_image_description
from ingestion.chunking import extract_chart_descriptions_from_pdf
from pathlib import Path

# Cách 1: Sử dụng hàm integrate sẵn
pdf_path = "./data/documents/report.pdf\"\ndescriptions = extract_chart_descriptions_from_pdf(pdf_path)\nfor page_num, desc in descriptions.items():\n    print(f\"Page {page_num}: {desc}\")\n\n\n# ============================================================================\n# EXAMPLE 2: Sử dụng custom prompt\n# ============================================================================\n\nimport io\nfrom pdf2image import convert_from_path\n\npdf_path = \"./data/documents/financial_report.pdf\"\npage_num = 1\n\n# Chuyển đổi trang thành hình ảnh\nimages = convert_from_path(pdf_path, first_page=page_num, last_page=page_num, fmt='jpeg', dpi=150)\n\nif images:\n    img = images[0]\n    img_byte_arr = io.BytesIO()\n    img.save(img_byte_arr, format='JPEG')\n    img_bytes = img_byte_arr.getvalue()\n    \n    # Custom prompt\n    custom_prompt = \"\"\"\n    Bạn là chuyên gia tài chính. Mô tả biểu đồ này:\n    1. Loại biểu đồ\n    2. Các chỉ tiêu chính\n    3. Xu hướng tăng/giảm\n    4. Kết luận\n    Sử dụng tiếng Việt.\n    \"\"\"\n    \n    description = generate_image_description(img_bytes, prompt=custom_prompt)\n    print(description)\n\n\n# ============================================================================\n# EXAMPLE 3: Xử lý nhiều trang\n# ============================================================================\n\nfrom config.settings import get_settings\nimport logging\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\ndef process_multiple_pdfs(pdf_folder: str):\n    \"\"\"\n    Xử lý tất cả PDF trong thư mục\n    \"\"\"\n    settings = get_settings()\n    \n    if not settings.enable_chart_description:\n        logger.warning(\"Chart description is disabled\")\n        return\n    \n    pdf_files = Path(pdf_folder).glob(\"*.pdf\")\n    \n    results = {}\n    for pdf_file in pdf_files:\n        logger.info(f\"Processing: {pdf_file.name}\")\n        descriptions = extract_chart_descriptions_from_pdf(str(pdf_file))\n        results[str(pdf_file)] = descriptions\n    \n    return results\n\n# Sử dụng\nresults = process_multiple_pdfs(\"./data/documents\")\nfor pdf_path, descriptions in results.items():\n    print(f\"\\n{pdf_path}:\")\n    for page, desc in descriptions.items():\n        print(f\"  Page {page}: {desc[:100]}...\")\n\n\n# ============================================================================\n# EXAMPLE 4: Kết hợp với RAG pipeline\n# ============================================================================\n\nfrom llama_index.core import Document\n\ndef enhance_document_with_charts(pdf_path: str) -> Document:\n    \"\"\"\n    Tạo Document tăng cường với chart descriptions\n    \"\"\"\n    import pdfplumber\n    \n    # Load text\n    text_content = \"\"\n    with pdfplumber.open(pdf_path) as pdf:\n        for page in pdf.pages:\n            text_content += page.extract_text() or \"\"\n    \n    # Load chart descriptions\n    chart_descriptions = extract_chart_descriptions_from_pdf(pdf_path)\n    \n    # Kết hợp\n    enhanced_content = text_content\n    if chart_descriptions:\n        enhanced_content += \"\\n\\n[CHART DESCRIPTIONS]\\n\"\n        for page_num, desc in sorted(chart_descriptions.items()):\n            enhanced_content += f\"\\nPage {page_num}: {desc}\\n\"\n    \n    # Tạo Document\n    doc = Document(\n        text=enhanced_content,\n        metadata={\n            'file_path': pdf_path,\n            'source_type': 'pdf_with_charts',\n            'has_charts': bool(chart_descriptions)\n        }\n    )\n    \n    return doc\n\n# Sử dụng\nenhanced_doc = enhance_document_with_charts(\"./data/documents/report.pdf\")\nprint(enhanced_doc.text)\nprint(enhanced_doc.metadata)\n\n\n# ============================================================================\n# EXAMPLE 5: Export kết quả\n# ============================================================================\n\nimport json\n\ndef export_chart_descriptions(pdf_path: str, output_format: str = \"json\"):\n    \"\"\"\n    Export mô tả biểu đồ theo định dạng khác nhau\n    \"\"\"\n    descriptions = extract_chart_descriptions_from_pdf(pdf_path)\n    \n    if output_format == \"json\":\n        output_path = pdf_path.replace(\".pdf\", \"_descriptions.json\")\n        with open(output_path, 'w', encoding='utf-8') as f:\n            json.dump(descriptions, f, ensure_ascii=False, indent=2)\n    \n    elif output_format == \"txt\":\n        output_path = pdf_path.replace(\".pdf\", \"_descriptions.txt\")\n        with open(output_path, 'w', encoding='utf-8') as f:\n            for page_num, desc in sorted(descriptions.items()):\n                f.write(f\"\\n{'='*60}\\n\")\n                f.write(f\"PAGE {page_num}\\n\")\n                f.write(f\"{'='*60}\\n\")\n                f.write(desc)\n                f.write(\"\\n\")\n    \n    elif output_format == \"markdown\":\n        output_path = pdf_path.replace(\".pdf\", \"_descriptions.md\")\n        with open(output_path, 'w', encoding='utf-8') as f:\n            f.write(f\"# Mô tả biểu đồ - {Path(pdf_path).name}\\n\\n\")\n            for page_num, desc in sorted(descriptions.items()):\n                f.write(f\"## Trang {page_num}\\n\\n\")\n                f.write(desc)\n                f.write(\"\\n\\n\")\n    \n    return output_path\n\n# Sử dụng\njson_file = export_chart_descriptions(\"./data/documents/report.pdf\", \"json\")\ntxt_file = export_chart_descriptions(\"./data/documents/report.pdf\", \"txt\")\nmd_file = export_chart_descriptions(\"./data/documents/report.pdf\", \"markdown\")\n\nprint(f\"✓ Exported: {json_file}\")\nprint(f\"✓ Exported: {txt_file}\")\nprint(f\"✓ Exported: {md_file}\")\n\n\n# ============================================================================\n# EXAMPLE 6: Xử lý lỗi\n# ============================================================================\n\ndef safe_process_pdf(pdf_path: str) -> dict:\n    \"\"\"\n    Xử lý PDF an toàn với error handling\n    \"\"\"\n    result = {\n        'status': 'pending',\n        'descriptions': None,\n        'error': None,\n        'message': None\n    }\n    \n    try:\n        # Kiểm tra file\n        if not Path(pdf_path).exists():\n            raise FileNotFoundError(f\"PDF not found: {pdf_path}\")\n        \n        # Kiểm tra cấu hình\n        settings = get_settings()\n        if not settings.enable_chart_description:\n            result['message'] = \"Chart description is disabled\"\n            result['status'] = 'skipped'\n            return result\n        \n        # Xử lý\n        descriptions = extract_chart_descriptions_from_pdf(pdf_path)\n        \n        result['status'] = 'success'\n        result['descriptions'] = descriptions\n        result['message'] = f\"Found {len(descriptions)} chart(s)\"\n        \n    except FileNotFoundError as e:\n        result['status'] = 'error'\n        result['error'] = 'file_not_found'\n        result['message'] = str(e)\n        \n    except Exception as e:\n        result['status'] = 'error'\n        result['error'] = type(e).__name__\n        result['message'] = str(e)\n    \n    return result\n\n# Sử dụng\nresult = safe_process_pdf(\"./data/documents/report.pdf\")\nprint(f\"Status: {result['status']}\")\nprint(f\"Message: {result['message']}\")\nif result['descriptions']:\n    print(f\"Descriptions: {result['descriptions']}\")\nif result['error']:\n    print(f\"Error: {result['error']}\")\n\n\n# ============================================================================\n# EXAMPLE 7: Batch processing với progress tracking\n# ============================================================================\n\nfrom tqdm import tqdm\nimport time\n\ndef batch_process_pdfs(pdf_folder: str, delay: float = 0.5) -> dict:\n    \"\"\"\n    Xử lý batch PDF với progress bar và delay (tránh rate limit)\n    \"\"\"\n    pdf_files = list(Path(pdf_folder).glob(\"*.pdf\"))\n    results = {}\n    \n    for pdf_file in tqdm(pdf_files, desc=\"Processing PDFs\"):\n        result = safe_process_pdf(str(pdf_file))\n        results[str(pdf_file)] = result\n        \n        # Delay để tránh rate limit API\n        time.sleep(delay)\n    \n    return results\n\n# Sử dụng\nresults = batch_process_pdfs(\"./data/documents\", delay=1.0)\nfor pdf_path, result in results.items():\n    status = \"✓\" if result['status'] == 'success' else \"✗\"\n    print(f\"{status} {Path(pdf_path).name}: {result['message']}\")\n\n\n# ============================================================================\n# CONFIGURATION\n# ============================================================================\n\n# .env file setup\nenv_template = \"\"\"\n# Vision LLM Configuration\nGITHUB_TOKEN=your_github_token_here\nGITHUB_MODELS_ENDPOINT=https://models.github.ai/inference\nGITHUB_VISION_MODEL=openai/gpt-4o\n\n# Feature flags\nENABLE_CHART_DESCRIPTION=true\n\"\"\"\n\nprint(\"Suggested .env configuration:\")\nprint(env_template)\n"